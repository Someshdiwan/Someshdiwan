name: Generate Streak SVG

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore:
      - 'streak.svg'
      - 'streak_state.json'

concurrency:
  group: generate-streak
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci || npm install

      - name: Generate streak.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node ./scripts/generate_streak.js

      - name: Bust README cache for streak.svg
        run: |
          RUN_ID="${{ github.run_id }}"
          sed -i -E 's#(streak\.svg)(\?v=[0-9]+)?#\1?v='"$RUN_ID"'#' README.md

      - name: Commit & push if changed (safe, auto-resolve README conflicts)
        env:
          BRANCH: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Make sure we have up-to-date refs
          git fetch origin "${BRANCH}" --depth=1 || true

          # Merge remote main into workspace BEFORE committing.
          # Use "-X theirs" so remote wins on conflicts (avoids the typical README cache-bust race).
          # If merge fails for some reason, fall back to a non-failing merge attempt.
          if git merge --no-edit -s recursive -X theirs "origin/${BRANCH}"; then
            echo "Merged origin/${BRANCH} (theirs wins for conflicts)."
          else
            echo "Merge reported conflicts; attempting graceful fallback..."
            git merge --no-edit "origin/${BRANCH}" || true
          fi

          # Stage the files the workflow changes (adjust paths if needed)
          git add streak.svg streak_state.json README.md || true

          # If nothing changed, exit cleanly.
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit the generated assets + README in one commit
          git commit -m "chore: update generated assets (auto)" || true

          # Push. If push fails (race), try to pull+reapply quickly:
          if git push origin "HEAD:${BRANCH}"; then
            echo "✅ Pushed successfully"
            exit 0
          fi

          echo "Push failed — trying rebase/pull retry..."
          git fetch origin "${BRANCH}"
          # Attempt safe rebase; if it fails, abort and try merge
          if git pull --rebase origin "${BRANCH}"; then
            git push origin "HEAD:${BRANCH}" && exit 0
          else
            git rebase --abort || true
            # As a last resort, merge with "theirs" strategy to keep origin main's conflict hunks
            git merge --no-edit -s recursive -X theirs "origin/${BRANCH}" || true
            git push origin "HEAD:${BRANCH}" || (echo "❌ Final push attempt failed" && exit 1)
          fi